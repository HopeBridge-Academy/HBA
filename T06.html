<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>گزارش تدریس - آکادمی هوپ‌بریج</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/i18next@21.6.10/dist/umd/i18next.min.js"></script>
    <script src="i18n.js" defer></script>

    <style>
        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            margin: 0;
            padding: 0;
            color: #2d3748;
            animation: fadeInBody 1s ease-in-out;
        }

        @keyframes fadeInBody {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        header {
            background-color: #3b82f6;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            animation: slideInHeader 0.5s ease-out;
        }

        @keyframes slideInHeader {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: flex-end;
        }

        .nav-list li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .nav-list li a:hover {
            opacity: 0.8;
        }

        main {
            max-width: 900px;
            margin: 2rem auto;
            background: rgb(219, 245, 241);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: fadeInMain 0.8s ease-in-out;
        }

        @keyframes fadeInMain {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        label {
            font-weight: bold;
            margin-top: 1rem;
            display: block;
            color: #2d3748;
        }

        input, textarea, select, button {
            width: 100%;
            padding: 0.6rem;
            margin-top: 0.3rem;
            border: 1px solid #43a330;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            outline: none;
        }

        button {
            background: #3b82f6;
            color: white;
            margin-top: 1.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background: #2563eb;
            transform: scale(1.02);
        }

        .delete-report-button, .send-report-button {
            background: #ef4444;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
            border-radius: 3px;
            margin-right: 0.5rem;
            transition: background-color 0.3s, transform 0.2s;
        }

        .send-report-button {
            background: #10b981;
        }

        .delete-report-button:hover {
            background: #dc2626;
            transform: scale(1.02);
        }

        .send-report-button:hover {
            background: #059669;
            transform: scale(1.02);
        }

        .send-report-button.sent {
            background: #059669;
            cursor: default;
        }

        .send-report-button.sent:hover {
            transform: none;
        }

        .export-button {
            background: #3b82f6;
            color: rgb(255, 255, 255);
            padding: 0.6rem 1rem;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.3s, transform 0.2s;
            display: inline-block;
        }

        .export-button:hover {
            background: #2563eb;
            transform: scale(1.02);
        }

        .export-button i {
            margin-left: 0.3rem;
        }

        iframe {
            width: 100%;
            height: 500px;
            margin: 1rem 0;
            border: 1px solid #d1d5db;
            border-radius: 5px;
        }

        .teacher-id {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .report-entry {
            background: #c4dbeb;
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            animation: scaleInImage 0.5s ease-out;
        }

        @keyframes scaleInImage {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .report-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subtitle {
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .exam-panel {
            margin-top: 2rem;
            background: #d5e6ae;
            padding: 1rem;
            border: 1px solid #acd3a8;
            border-radius: 10px;
            animation: fadeInForm 0.6s ease-in-out;
        }

        @keyframes fadeInForm {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .exam-panel h3 {
            color: #e65100;
            margin-top: 0;
        }

        .exam-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: #fff9f0;
            border: 1px solid #ffe0b2;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exam-entry span {
            flex-grow: 1;
        }

        .exam-entry button {
            background: #ef4444;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
            border-radius: 3px;
            margin-left: 1rem;
            transition: background-color 0.3s, transform 0.2s;
        }

        .exam-entry button:hover {
            background: #dc2626;
            transform: scale(1.02);
        }

        .add-exam-form {
            margin-top: 1rem;
            border-top: 1px solid #d1d5db;
            padding-top: 1rem;
        }

        .add-exam-form input {
            width: auto;
            display: inline-block;
            margin-left: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .add-exam-form label {
            display: inline-block;
            width: 90px;
            margin-left: 0.5rem;
        }

        .add-exam-form button {
            width: auto;
            margin-top: 0;
        }

        .send-report-button::before {
            content: '\f1d8';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: 0.3rem;
        }

        .send-report-button.sent::before {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: 0.3rem;
        }

        .sent-icon {
            color: #059669;
            margin-right: 0.3rem;
        }
    </style>
</head>
<body>
<header>
    سامانه ثبت گزارش تدریس - آکادمی هوپ‌بریج
    <nav>
        <ul class="nav-list">
            <li><a href="#" id="logout-link" data-i18n="logout">خروج</a></li>
        </ul>
    </nav>
</header>
<main>
    <p class="teacher-id">کد استاد: <span id="teacherId">TCHR-001</span></p>

    <iframe src="plan.pdf" title="برنامه تدریس"></iframe>

    <form id="reportForm">
        <input type="hidden" name="teacher_id" id="formTeacherId" value="TCHR-001" />

        <label>انتخاب صنف:</label>
        <select id="class" name="class" required>
            <option value="">-- انتخاب صنف --</option>
            <optgroup label="کمپیوتر">
                <option value="کمپیوتر A">کمپیوتر A</option>
                <option value="کمپیوتر B">کمپیوتر B</option>
                <option value="کمپیوتر C">کمپیوتر C</option>
            </optgroup>
            <optgroup label="انگلیسی">
                <option value="انگلیسی A">انگلیسی A</option>
                <option value="انگلیسی B">انگلیسی B</option>
                <option value="انگلیسی C">انگلیسی C</option>
            </optgroup>
            <optgroup label="دیگر">
                <option value="دیگر A">دیگر A</option>
                <option value="دیگر B">دیگر B</option>
                <option value="دیگر C">دیگر C</option>
            </optgroup>
        </select>

        <label>تاریخ:</label>
        <input type="date" id="date" name="date" required />

        <label>موضوع درس:</label>
        <input type="text" id="subject" name="subject" required />

        <label>مدت زمان تدریس:</label>
        <input type="text" id="duration" name="duration" required />

        <label>محتوای تدریس‌شده:</label>
        <textarea id="content" name="content" required></textarea>

        <label>ارزیابی سطح یادگیری:</label>
        <textarea id="assessment" name="assessment" required></textarea>

        <label>مشکلات یا چالش‌ها:</label>
        <textarea id="challenges" name="challenges"></textarea>

        <label>پیشنهادات استاد:</label>
        <textarea id="suggestions" name="suggestions"></textarea>

        <label>وضعیت حضور:</label>
        <select name="presence_level" id="presence" required>
            <option value="">انتخاب کنید</option>
            <option value="full">همه حاضر بودند</option>
            <option value="partial">برخی غایب بودند</option>
            <option value="low">حضور بسیار پایین</option>
        </select>

        <label>تعداد حاضر و غایب:</label>
        <textarea id="attendance" name="attendance" required></textarea>

        <button type="submit">ذخیره گزارش</button>
    </form>

    <div id="reportDisplay">
        <h3>گزارش‌های ثبت‌شده</h3>
    </div>

    <div class="exam-panel">
        <h3>نتایج امتحان</h3>

        <div id="localExamResults"></div>

        <form id="addExamResultForm" class="add-exam-form">
            <label>نام شاگرد:</label>
            <input type="text" id="studentName" required placeholder="مثلا: احمد رحیمی" />

            <label>کد شاگرد:</label>
            <input type="text" id="studentId" required placeholder="مثلا: STD-051" />

            <label>نمره:</label>
            <input type="number" id="studentScore" required min="0" max="100" placeholder="مثلا: 85" />

            <button type="submit">افزودن نمره</button>
        </form>

        <form id="examForm" method="POST" style="margin-top:1rem;">
            <input type="hidden" name="teacher_id" value="TCHR-001" />
            <div id="examFormInputs"></div>
            <button type="submit" id="submitExamResults">ثبت نتایج امتحان</button>
        </form>
    </div>
</main>

<script src="script.js" defer></script>
<script>
    // بررسی وضعیت ورود
    if (sessionStorage.getItem('isLoggedIn') !== 'true' || 
        (sessionStorage.getItem('userType') !== 'teacher' && 
         sessionStorage.getItem('userType') !== 'admin' && 
         sessionStorage.getItem('userType') !== 'superadmin')) {
        window.location.href = 'login.html';
    }

    // مدیریت لینک خروج
    document.getElementById('logout-link').addEventListener('click', function(e) {
        e.preventDefault();
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('userRole');
        sessionStorage.removeItem('userType');
        window.location.href = 'login.html';
    });

    const teacherId = 'TCHR-006';
    document.getElementById('teacherId').textContent = teacherId;
    document.getElementById('formTeacherId').value = teacherId;
    document.querySelector('#examForm input[name="teacher_id"]').value = teacherId;

    const reportKey = `reports-${teacherId}`;
    const examKey = `exam-results-${teacherId}`;

    const reportForm = document.getElementById('reportForm');
    const examForm = document.getElementById('examForm');
    const examFormInputs = document.getElementById('examFormInputs');

    reportForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const report = {
            class: document.getElementById('class').value,
            date: document.getElementById('date').value,
            subject: document.getElementById('subject').value,
            duration: document.getElementById('duration').value,
            content: document.getElementById('content').value,
            assessment: document.getElementById('assessment').value,
            challenges: document.getElementById('challenges').value,
            suggestions: document.getElementById('suggestions').value,
            presence: document.getElementById('presence').value,
            attendance: document.getElementById('attendance').value,
            sent: false
        };
        const existingReports = JSON.parse(localStorage.getItem(reportKey)) || [];
        existingReports.push(report);
        localStorage.setItem(reportKey, JSON.stringify(existingReports));
        showReports(existingReports);
        reportForm.reset();
    });

    function showReports(reports) {
        const display = document.getElementById('reportDisplay');
        display.innerHTML = `
            <h3 data-i18n="savedReports">گزارش‌های ثبت‌شده</h3>
        `;
        if (reports.length === 0) {
            display.innerHTML += '<p data-i18n="noReports">گزارشی ثبت نشده است.</p>';
        } else {
            reports.forEach((r, index) => {
                const div = document.createElement('div');
                div.className = 'report-entry';
                div.innerHTML = `
                    <div class="report-entry-header">
                        <div class="subtitle">${r.date} - ${r.class} / ${r.subject}</div>
                        <div>
                            <button class="send-report-button ${r.sent ? 'sent' : ''}" data-index="${index}" ${r.sent ? 'disabled' : ''} data-i18n="sendReport">${r.sent ? i18next.t('sent') : i18next.t('sendReport')}</button>
                            <button class="delete-report-button" data-index="${index}" data-i18n="deleteReport">حذف</button>
                        </div>
                    </div>
                    <p><strong data-i18n="durationLabel">مدت تدریس:</strong> ${r.duration}</p>
                    <p><strong data-i18n="contentLabel">محتوا:</strong> ${r.content}</p>
                    <p><strong data-i18n="assessmentLabel">ارزیابی یادگیری:</strong> ${r.assessment}</p>
                    <p><strong data-i18n="challengesLabel">مشکلات:</strong> ${r.challenges || i18next.t('none') || 'ندارد'}</p>
                    <p><strong data-i18n="suggestionsLabel">پیشنهادات:</strong> ${r.suggestions || i18next.t('none') || 'ندارد'}</p>
                    <p><strong data-i18n="presenceLabel">حضور:</strong> ${r.presence}</p>
                    <p><strong data-i18n="attendanceLabel">تعداد حاضر و غایب:</strong> ${r.attendance}</p>
                `;
                display.appendChild(div);
            });
        }

        document.querySelectorAll('.delete-report-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-index');
                deleteReport(idx);
            });
        });

        document.querySelectorAll('.send-report-button:not(.sent)').forEach(button => {
            button.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-index');
                sendTeachingReportToTelegram(idx, e.target);
            });
        });
    }

    function deleteReport(index) {
        const reports = JSON.parse(localStorage.getItem(reportKey)) || [];
        reports.splice(index, 1);
        localStorage.setItem(reportKey, JSON.stringify(reports));
        showReports(reports);
    }

    function sendTeachingReportToTelegram(index, button) {
        const token = "7637224975:AAH7Al4buvRmfwW3LUZ-REvloF9rZgoAStU"; // Your Bot Token
        const chatId = "-1002886209903"; // Your Telegram Group Chat ID
        const reports = JSON.parse(localStorage.getItem(reportKey)) || [];
        const report = reports[index];

        if (!report) {
            alert(i18next.t('reportNotFound') || 'گزارش یافت نشد.');
            return;
        }

        const message = `
📨 ${i18next.t('newTeachingReport') || 'گزارش جدید تدریس از آکادمی هوپ‌بریج'}
📋 ${i18next.t('teacherId') || 'کد استاد'}: ${teacherId}
📚 ${i18next.t('classLabel') || 'صنف'}: ${report.class}
📅 ${i18next.t('dateLabel') || 'تاریخ'}: ${report.date}
📖 ${i18next.t('subjectLabel') || 'موضوع'}: ${report.subject}
⏰ ${i18next.t('durationLabel') || 'مدت تدریس'}: ${report.duration}
📝 ${i18next.t('contentLabel') || 'محتوا'}: ${report.content}
✅ ${i18next.t('assessmentLabel') || 'ارزیابی'}: ${report.assessment}
⚠️ ${i18next.t('challengesLabel') || 'مشکلات'}: ${report.challenges || i18next.t('none') || 'ندارد'}
💡 ${i18next.t('suggestionsLabel') || 'پیشنهادات'}: ${report.suggestions || i18next.t('none') || 'ندارد'}
👥 ${i18next.t('presenceLabel') || 'حضور'}: ${report.presence}
🔢 ${i18next.t('attendanceLabel') || 'تعداد حاضر و غایب'}: ${report.attendance}
        `;

        const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}`;

        fetch(url)
            .then(response => {
                if (response.ok) {
                    reports[index].sent = true;
                    localStorage.setItem(reportKey, JSON.stringify(reports));
                    button.classList.add('sent');
                    button.setAttribute('disabled', 'disabled');
                    button.innerHTML = `${i18next.t('sent') || 'ارسال‌شده'} <i class="fas fa-check"></i>`;
                    alert(i18next.t('reportSent') || "✅ گزارش تدریس به تلگرام ارسال شد!");
                } else {
                    alert(i18next.t('sendError') || "❌ خطا در ارسال گزارش تدریس به تلگرام.");
                }
            })
            .catch(error => {
                alert(i18next.t('error') || "⚠️ خطا: ") + error;
            });
    }

    function sendExamResultsToTelegram(e) {
        e.preventDefault();
        const token = "7637224975:AAH7Al4buvRmfwW3LUZ-REvloF9rZgoAStU"; // Your Bot Token
        const chatId = "-1002886209903"; // Your Telegram Group Chat ID
        const exams = JSON.parse(localStorage.getItem(examKey)) || [];

        if (exams.length === 0) {
            alert(i18next.t('noExamResults') || 'هیچ نتیجه امتحانی برای ارسال وجود ندارد.');
            return;
        }

        if (exams.every(exam => exam.sent)) {
            alert(i18next.t('resultsAlreadySent') || 'نتایج امتحان قبلاً ارسال شده‌اند.');
            return;
        }

        let examDetails = exams.map((exam, i) => `
${i + 1}. ${i18next.t('studentName') || 'نام شاگرد'}: ${exam.studentName}
   ${i18next.t('studentId') || 'کد شاگرد'}: ${exam.studentId}
   ${i18next.t('score') || 'نمره'}: ${exam.score}
        `).join('\n');

        const message = `
📝 ${i18next.t('examResults') || 'نتایج امتحان از آکادمی هوپ‌بریج'}
📋 ${i18next.t('teacherId') || 'کد استاد'}: ${teacherId}
📅 ${i18next.t('submissionDate') || 'تاریخ ارسال'}: ${new Date().toLocaleString('fa-IR')}
📊 ${i18next.t('results') || 'نتایج'}:
${examDetails}
        `;

        const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}`;

        fetch(url)
            .then(response => {
                if (response.ok) {
                    exams.forEach(exam => { exam.sent = true; });
                    localStorage.setItem(examKey, JSON.stringify(exams));
                    loadExamResults();
                    alert(i18next.t('examResultsSent') || "✅ نتایج امتحان به تلگرام ارسال شد!");
                } else {
                    alert(i18next.t('sendError') || "❌ خطا در ارسال نتایج امتحان به تلگرام.");
                }
            })
            .catch(error => {
                alert(i18next.t('error') || "⚠️ خطا: ") + error;
            });
    }

    window.addEventListener('load', () => {
        const savedReports = JSON.parse(localStorage.getItem(reportKey));
        if (savedReports && savedReports.length > 0) {
            showReports(savedReports);
        } else {
            showReports([]);
        }
        loadExamResults();

        examForm.addEventListener('submit', sendExamResultsToTelegram);
    });

    const localExamResultsDiv = document.getElementById('localExamResults');
    const addExamResultForm = document.getElementById('addExamResultForm');

    function loadExamResults() {
        const exams = JSON.parse(localStorage.getItem(examKey)) || [];
        renderExamResults(exams);
        updateExamFormInputs(exams);
        const submitButton = document.getElementById('submitExamResults');
        if (exams.length > 0 && exams.every(exam => exam.sent)) {
            submitButton.disabled = true;
            submitButton.classList.add('sent');
            submitButton.innerHTML = `${i18next.t('sent') || 'ارسال‌شده'} <i class="fas fa-check"></i>`;
        } else {
            submitButton.disabled = false;
            submitButton.classList.remove('sent');
            submitButton.innerHTML = i18next.t('submitExamResults') || 'ثبت نتایج امتحان';
        }
    }

    function renderExamResults(exams) {
        localExamResultsDiv.innerHTML = '';
        if (exams.length === 0) {
            localExamResultsDiv.innerHTML = `<p data-i18n="noResults">${i18next.t('noResults') || 'نتایجی ثبت نشده است.'}</p>`;
            return;
        }
        exams.forEach((exam, index) => {
            const div = document.createElement('div');
            div.className = 'exam-entry';
            div.innerHTML = `
                <span>${exam.studentName} (${exam.studentId}) - ${i18next.t('score') || 'نمره'}: ${exam.score} ${exam.sent ? '<i class="fas fa-check sent-icon"></i>' : ''}</span>
                <button data-index="${index}" data-i18n="deleteResult">حذف</button>
            `;
            localExamResultsDiv.appendChild(div);
        });

        localExamResultsDiv.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-index');
                deleteExamResult(idx);
            });
        });
    }

    function deleteExamResult(index) {
        const exams = JSON.parse(localStorage.getItem(examKey)) || [];
        exams.splice(index, 1);
        localStorage.setItem(examKey, JSON.stringify(exams));
        loadExamResults();
    }

    addExamResultForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const studentName = document.getElementById('studentName').value.trim();
        const studentId = document.getElementById('studentId').value.trim();
        const score = document.getElementById('studentScore').value.trim();

        if (!studentName || !studentId || score === '') {
            alert(i18next.t('fillAllFields') || 'لطفاً همه فیلدها را پر کنید.');
            return;
        }

        const exams = JSON.parse(localStorage.getItem(examKey)) || [];
        exams.push({ studentName, studentId, score, sent: false });
        localStorage.setItem(examKey, JSON.stringify(exams));
        addExamResultForm.reset();
        loadExamResults();
    });

    function updateExamFormInputs(exams) {
        examFormInputs.innerHTML = '';
        exams.forEach((exam, i) => {
            examFormInputs.innerHTML += `
                <input type="hidden" name="students[${i}][name]" value="${exam.studentName}" />
                <input type="hidden" name="students[${i}][id]" value="${exam.studentId}" />
                <input type="hidden" name="students[${i}][score]" value="${exam.score}" />
            `;
        });
    }
</script>
</body>
</html>
